{"version":3,"file":"consumer.js","sourceRoot":"","sources":["../../../../shared/src/consumer/consumer.ts"],"names":[],"mappings":";;AAKA,+EAAyF;AAIzF;IAQE,YAAY,YAAY,EAAE,iBAAiB;QALnC,kBAAa,GAAwB,EAAE,CAAC;QAM9C,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;QACjC,IAAI,CAAC,iBAAiB,GAAG,iBAAiB,CAAC;QAC3C,2EAA2E;IAC7E,CAAC;IAED,IAAI;QACF,OAAO,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC;QAC7B,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YACrC,IAAI,CAAC,iBAAiB,CAAC,gBAAgB,CAAC,qCAAW,CAAC,QAAQ,CAAC;iBACxD,IAAI,CAAC,CAAC,cAA8B,EAAE,EAAE;gBACvC,OAAO,CAAC,GAAG,CAAC,uCAAuC,CAAC,CAAC;gBACrD,IAAI,CAAC,eAAe,GAAG,cAAc,CAAC;gBACtC,OAAO,EAAE,CAAC;YACZ,CAAC,CAAC,CAAC;QACT,CAAC,CAAC,CAAC;IAEL,CAAC;IAKD,YAAY,CAAC,gBAAgB,GAAG,EAAE;QAChC,IAAI,CAAC,GAAG,CAAC,CAAC;QACV,OAAO,CAAC,GAAG,gBAAgB,EAAE;YAC3B,qFAAqF;YACrF,CAAC,EAAE,CAAC;SACL;IACH,CAAC;IAGD,gBAAgB,CAAC,eAAuC,EAAE,KAAM,EAAE,OAAyB;QACzF,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YAErC,MAAM,YAAY,GAAG,IAAI,CAAC,eAAe,CAAC,aAAa,CAAC,KAAK,EAAE,OAAO,CAAC;iBAClE,SAAS,CAAC,CAAC,IAAI,EAAE,EAAE;gBAClB,eAAe,CAAC,IAAI,CAAC;qBAChB,IAAI,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;qBAC1B,KAAK,CAAC,GAAG,CAAC,EAAE;oBACX,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;oBACjB,IAAI,CAAC,IAAI,CAAC,eAAe,CAAC,aAAa,EAAE,EAAE;wBACzC,YAAY,CAAC,WAAW,EAAE,CAAC;wBAC3B,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;wBAClB,OAAO,MAAM,EAAE,CAAC;qBACjB;gBACH,CAAC,CAAC,CAAC;YACT,CAAC,CAAC,CAAC;YACP,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QACxC,CAAC,CAAC,CAAC;IACL,CAAC;IAED,GAAG,CAAC,GAAY;QACd,OAAO,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;IACvC,CAAC;IAED,MAAM,CAAC,GAAY;QACjB,OAAO,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;IAC1C,CAAC;IAED,OAAO;QACL,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,YAAY,CAAC,EAAE,CAAC,YAAY,CAAC,WAAW,EAAE,CAAC,CAAC;IACzE,CAAC;CACF;AAtED,4BAsEC","sourcesContent":["import { RabbitConsumer } from '../rabbit/rabbitConsumer';\r\nimport { Options } from 'amqplib/properties';\r\nimport { Connection, Message } from 'amqplib';\r\nimport { Subscription } from 'rxjs/index';\r\nimport { RabbitConfig } from '../interfase/rabitConfig';\r\nimport { CreatesType, RabbitConnectionManager } from '../rabbit/rabbitConnectionManager';\r\nimport { RabbitProducer } from '../rabbit/rabbitProducer';\r\n\r\n\r\nexport class Consumer {\r\n\r\n  protected rabbitConsumers: RabbitConsumer;\r\n  private subscriptions: Array<Subscription> = [];\r\n  private connectionManager: RabbitConnectionManager;\r\n  private rabbitConfig: RabbitConfig;\r\n\r\n\r\n  constructor(rabbitConfig, connectionManager) {\r\n    this.rabbitConfig = rabbitConfig;\r\n    this.connectionManager = connectionManager;\r\n    // this.rabbitConsumers.push(new RabbitConsumer(rabbitConfig, connection));\r\n  }\r\n\r\n  init(): Promise<void> {\r\n    console.log('init consumer');\r\n    return new Promise((resolve, reject) => {\r\n      this.connectionManager.spawnQueueWorker(CreatesType.CONSUMER)\r\n          .then((rabbitConsumer: RabbitConsumer) => {\r\n            console.log('[consumer]: new worker spawn consumer');\r\n            this.rabbitConsumers = rabbitConsumer;\r\n            resolve();\r\n          });\r\n    });\r\n\r\n  }\r\n\r\n\r\n\r\n\r\n  initChannels(numberOfChannels = 10) {\r\n    let i = 0;\r\n    while (i < numberOfChannels) {\r\n      // this.rabbitConsumers.push(new RabbitConsumer(this.rabbitConfig, this.connection));\r\n      i++;\r\n    }\r\n  }\r\n\r\n\r\n  consumeFromQueue(promiseFunction: (data) => Promise<any>, queue?, options?: Options.Consume) {\r\n    return new Promise((resolve, reject) => {\r\n\r\n      const subscription = this.rabbitConsumers.clientConsume(queue, options)\r\n          .subscribe((data) => {\r\n            promiseFunction(data)\r\n                .then(() => this.ack(data))\r\n                .catch(err => {\r\n                  console.log(err);\r\n                  if (!this.rabbitConsumers.clientConsume()) {\r\n                    subscription.unsubscribe();\r\n                    this.cancel(data);\r\n                    return reject();\r\n                  }\r\n                });\r\n          });\r\n      this.subscriptions.push(subscription);\r\n    });\r\n  }\r\n\r\n  ack(msg: Message) {\r\n    return this.rabbitConsumers.ack(msg);\r\n  }\r\n\r\n  cancel(msg: Message) {\r\n    return this.rabbitConsumers.cancel(msg);\r\n  }\r\n\r\n  destory() {\r\n    this.subscriptions.forEach(subscription => subscription.unsubscribe());\r\n  }\r\n}\r\n"]}