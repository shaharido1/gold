{"version":3,"file":"redisMQ.js","sourceRoot":"","sources":["../../../../../../shared/src/modules/redis/src/redisMQ.ts"],"names":[],"mappings":";;AAAA,iDAA+C;AAC/C,4CAA4C;AAG5C,oBAA4B,SAAQ,4BAAa;IAK/C,4CAA4C;IAE5C,QAAQ;QACN,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YACrC,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;YACxB,IAAI,CAAC,oBAAoB,EAAE;iBACtB,IAAI,CAAC,MAAM,CAAC,EAAE;gBACb,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;gBACrB,IAAI,CAAC,IAAI,GAAG,IAAI,WAAW,CAAC,EAAE,MAAM,EAAE,CAAC,CAAC;gBACxC,IAAI,CAAC,WAAW,EAAE;qBACb,IAAI,CAAC,GAAG,EAAE;oBACT,OAAO,CAAC,GAAG,CAAC,mBAAmB,CAAC,CAAC;oBACjC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,qBAAqB,CAAC,CAAC;oBAC/C,OAAO,OAAO,EAAE,CAAC;gBACnB,CAAC,CAAC,CAAC;YACT,CAAC,CAAC;iBACD,KAAK,CAAC,GAAG,CAAC,EAAE;gBACX,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;gBACjB,OAAO,MAAM,CAAC,GAAG,CAAC,CAAC;YACrB,CAAC,CAAC,CAAC;QACT,CAAC,CAAC,CAAC;IACL,CAAC;IAGO,WAAW,CAAC,KAAM;QACxB,IAAI,KAAK,KAAK,SAAS,EAAE;YACvB,IAAI,CAAC,MAAM,CAAC,qBAAqB,GAAG,KAAK,CAAC;SAC3C;QAED,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YACrC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,IAAI,CAAC,MAAM,CAAC,qBAAqB,IAAI,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;gBAC7E,IAAI,GAAG,IAAI,CAAC,EAAE;oBACZ,OAAO,CAAC,GAAG,CAAC,SAAS,IAAI,CAAC,MAAM,CAAC,qBAAqB,gBAAgB,CAAC,CAAC;oBACxE,OAAO,OAAO,EAAE,CAAC;iBAClB;gBACD,IAAI,GAAG,EAAE;oBACP,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;iBACpB;qBACI;oBACH,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,EAAE,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,qBAAqB,EAAE,CAAC;yBAC9D,IAAI,CAAC,GAAG,EAAE;wBACT,OAAO,CAAC,GAAG,CAAC,SAAS,IAAI,CAAC,MAAM,CAAC,qBAAqB,WAAW,CAAC,CAAC;wBACnE,OAAO,OAAO,EAAE,CAAC;oBACnB,CAAC,CAAC;yBACD,KAAK,CAAC,GAAG,CAAC,EAAE;wBACX,IAAI,GAAG,EAAE;4BACP,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;4BACnB,OAAO,MAAM,EAAE,CAAC;yBACjB;oBACH,CAAC,CAAC,CAAC;iBACR;YAEH,CAAC,CAAC,CAAC;QAEL,CAAC,CAAC,CAAC;IACL,CAAC;IAEM,WAAW,CAAC,OAAO,EAAE,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,qBAAqB;QACnE,OAAO,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;QACrB,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YACrC,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,EAAE,KAAK,EAAE,OAAO,EAAE,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,EAAE,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;gBAC9E,IAAI,GAAG,EAAE;oBACP,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;oBACjB,OAAO,MAAM,CAAC,GAAG,CAAC,CAAC;iBACpB;qBACI,IAAI,GAAG,EAAE;oBACZ,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC;iBACrB;qBACI;oBACH,OAAO,CAAC,GAAG,CAAC,6BAA6B,CAAC,CAAC;oBAC3C,OAAO,MAAM,EAAE,CAAC;iBACjB;YACH,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;CAGF;AAlFD,wCAkFC","sourcesContent":["import { RedisAdapter2 } from './redisAdapter';\r\nimport * as RSMQPromise from 'rsmq-promise';\r\nimport { RedisClient } from 'redis';\r\n\r\nexport class RedisMqAdapter extends RedisAdapter2 {\r\n\r\n  client: RedisClient;\r\n  rsmq: RSMQPromise;\r\n\r\n  // private unDeletedMsg: Array<string> = [];\r\n\r\n  initRMSQ(): Promise<RSMQPromise> {\r\n    return new Promise((resolve, reject) => {\r\n      console.log('initRMSQ');\r\n      this.initClientConnection()\r\n          .then(client => {\r\n            this.client = client;\r\n            this.rsmq = new RSMQPromise({ client });\r\n            this.assertQueue()\r\n                .then(() => {\r\n                  console.log('finished assert Q');\r\n                  console.log(this.config.config_redisQueueName);\r\n                  return resolve();\r\n                });\r\n          })\r\n          .catch(err => {\r\n            console.log(err);\r\n            return reject(err);\r\n          });\r\n    });\r\n  }\r\n\r\n\r\n  private assertQueue(qname?): Promise<void> {\r\n    if (qname !== undefined) {\r\n      this.config.config_redisQueueName = qname;\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      this.client.exists(`rsmq:${this.config.config_redisQueueName}:Q`, (err, res) => {\r\n        if (res >= 1) {\r\n          console.log(`Queue ${this.config.config_redisQueueName} already exist`);\r\n          return resolve();\r\n        }\r\n        if (err) {\r\n          console.error(err);\r\n        }\r\n        else {\r\n          this.rsmq.createQueue({ qname: this.config.config_redisQueueName })\r\n              .then(() => {\r\n                console.log(`Queue ${this.config.config_redisQueueName} created!`);\r\n                return resolve();\r\n              })\r\n              .catch(err => {\r\n                if (err) {\r\n                  console.error(err);\r\n                  return reject();\r\n                }\r\n              });\r\n        }\r\n\r\n      });\r\n\r\n    });\r\n  }\r\n\r\n  public sendMassage(message, qname = this.config.config_redisQueueName): Promise<any> {\r\n    console.log((qname));\r\n    return new Promise((resolve, reject) => {\r\n      this.rsmq.sendMessage({ qname, message: JSON.stringify(message) }, (err, res) => {\r\n        if (err) {\r\n          console.log(err);\r\n          return reject(err);\r\n        }\r\n        else if (res) {\r\n          return resolve(res);\r\n        }\r\n        else {\r\n          console.log('error with no error message');\r\n          return reject();\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n\r\n}"]}